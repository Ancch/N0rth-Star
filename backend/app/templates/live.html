<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>North Star | Live Alerts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f17; color:#e7eefc; margin:0; }
    header { padding:18px 22px; border-bottom:1px solid #1d2a44; display:flex; justify-content:space-between; align-items:center; }
    .badge { font-size:12px; padding:4px 10px; border:1px solid #2a3a5e; border-radius:999px; color:#b8c7ff; }
    .wrap { max-width:1100px; margin:0 auto; padding:18px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:14px; }
    .card { background:#0f1626; border:1px solid #1d2a44; border-radius:14px; padding:14px; }
    .row { display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .title { font-weight:650; font-size:14px; margin:6px 0 10px; }
    .meta { font-size:12px; color:#a6b4d6; }
    .pill { font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid #2a3a5e; }
    .score { font-weight:700; }
    .small { font-size:12px; color:#a6b4d6; margin-top:8px; overflow-wrap:anywhere; }
    a { color:#8fb4ff; text-decoration:none; }
  </style>
</head>
<body>
  <header>
    <div>
      <div style="font-weight:800;font-size:16px;">North Star</div>
      <div class="meta">Live Threat Feed (SSE)</div>
    </div>
    <div class="badge" id="status">connecting…</div>
  </header>

  <div class="wrap">
    <div class="grid" id="grid"></div>
  </div>

  <script>
    const grid = document.getElementById("grid");
    const statusEl = document.getElementById("status");

    function cardHTML(a) {
      const title = a.title || "(untitled)";
      const url = a.url || "";
      const created = a.created_at || "";
      return `
        <div class="card">
          <div class="row">
            <div class="pill">${a.category}</div>
            <div class="score">Score: ${Number(a.score).toFixed(1)}</div>
          </div>
          <div class="title">${escapeHtml(title)}</div>
          <div class="meta">
            Sector: <b>${escapeHtml(a.sector)}</b> · Intent: <b>${escapeHtml(a.intent)}</b><br/>
            Time: ${escapeHtml(created)}
          </div>
          <div class="small">
            Source: ${escapeHtml(a.source || "-")}<br/>
            URL: ${url ? `<a href="${escapeAttr(url)}" target="_blank">${escapeHtml(url)}</a>` : "-"}
          </div>
        </div>
      `;
    }

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s); }

    const es = new EventSource("/alerts/stream");
    es.onopen = () => { statusEl.textContent = "connected"; };
    es.onerror = () => { statusEl.textContent = "disconnected"; };

    es.addEventListener("alert", (evt) => {
      const a = JSON.parse(evt.data);
      const div = document.createElement("div");
      div.innerHTML = cardHTML(a);
      // newest first
      grid.prepend(div.firstElementChild);
    });
  </script>
</body>
</html>
